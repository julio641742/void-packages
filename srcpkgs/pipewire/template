# Template file for 'pipewire'
pkgname=pipewire
version=0.3.13
revision=1
build_style=meson
configure_args="-Dman=true -Dgstreamer=true -Ddocs=true -Dsystemd=false
 -Dbluez5=true -Dffmpeg=true -Dpipewire-alsa=true -Dpipewire-jack=true
 -Dvolume=true -Dpipewire-pulseaudio=true -Dudevrulesdir=/usr/lib/udev/rules.d"
hostmakedepends="doxygen graphviz pkg-config xmltoman"
makedepends="SDL2-devel ffmpeg-devel gst-plugins-base1-devel jack-devel
 sbc-devel v4l-utils-devel libva-devel libbluetooth-devel"
depends="rtkit"
short_desc="Server and user space API to deal with multimedia pipelines"
maintainer="Kridsada Thanabulpong <sirn@ogsite.net>"
license="MIT"
homepage="https://pipewire.org/"
changelog="https://gitlab.freedesktop.org/pipewire/pipewire/-/raw/master/NEWS"
distfiles="https://gitlab.freedesktop.org/pipewire/pipewire/-/archive/${version}/pipewire-${version}.tar.gz"
checksum=40f2db86d8ba14706bfab8ee7c1789aeeb72bee386d1e44dbcd98888ef9861e5
conf_files="/etc/pipewire/pipewire.conf"

if [ "$XBPS_TARGET_NO_ATOMIC8" ]; then
	makedepends+=" libatomic-devel"
	LDFLAGS+=" -latomic"
fi

post_install() {
	vinstall ${FILESDIR}/pipewire.desktop 644 etc/xdg/autostart
	vlicense LICENSE
}

libpipewire_package() {
	short_desc+=" - pipewire library"
	pkg_install() {
		vmove "usr/lib/libpipewire-0.3.so.*"
		vmove "usr/lib/pipewire-0.3/*.so"
	}
}

pipewire-devel_package() {
	depends="libpipewire-${version}_${revision}"
	short_desc+=" - pipewire and libspa development files"
	pkg_install() {
		vmove usr/include/pipewire-0.3
		vmove usr/include/spa-0.2
		vmove usr/lib/pkgconfig/libpipewire-0.3.pc
		vmove usr/lib/pkgconfig/libspa-0.2.pc
		vmove usr/lib/libpipewire-0.3.so
	}
}

libspa-alsa_package() {
	short_desc+=" - alsa plugins"
	pkg_install() {
		vmove usr/lib/spa-0.2/alsa
	}
}

libspa-audioconvert_package() {
	short_desc+=" - audioconvert plugins"
	pkg_install() {
		vmove usr/lib/spa-0.2/audioconvert
	}
}

libspa-audiomixer_package() {
	short_desc+=" - audiomixer plugins"
	pkg_install() {
		vmove usr/lib/spa-0.2/audiomixer
	}
}

libspa-bluetooth_package() {
	short_desc+=" - bluetooth plugins"
	pkg_install() {
		vmove usr/lib/spa-0.2/bluez5
	}
}

libspa-control_package() {
	short_desc+=" - control plugins"
	pkg_install() {
		vmove usr/lib/spa-0.2/control
	}
}

libspa-ffmpeg_package() {
	short_desc+=" - ffmpeg plugins"
	pkg_install() {
		vmove usr/lib/spa-0.2/ffmpeg
	}
}

libspa-jack_package() {
	short_desc+=" - jack plugins"
	pkg_install() {
		vmove usr/lib/spa-0.2/jack
	}
}

libspa-v4l2_package() {
	short_desc+=" - v4l2 plugins"
	pkg_install() {
		vmove usr/lib/spa-0.2/v4l2
	}
}

libspa-videoconvert_package() {
	short_desc+=" - videoconvert plugins"
	pkg_install() {
		vmove usr/lib/spa-0.2/videoconvert
	}
}

libspa-vulkan_package() {
	short_desc+=" - vulkan plugins"
	pkg_install() {
		vmove usr/lib/spa-0.2/vulkan
	}
}

libspa-volume_package() {
	short_desc+=" - volume plugins"
	pkg_install() {
		vmove usr/lib/spa-0.2/volume
	}
}

gstreamer1-pipewire_package() {
	short_desc+=" - gstreamer plugin"
	pkg_install() {
		vmove usr/lib/gstreamer-1.0
	}
}

libpulseaudio-pipewire_package() {
	depends="libpipewire-${version}_${revision}"
	short_desc+=" - PulseAudio client library"
	pkg_install() {
		vmove usr/lib/pipewire-0.3/pulse
		vmove usr/bin/pw-pulse
	}
}

alsa-pipewire_package() {
	depends="libpipewire-${version}_${revision}"
	short_desc+=" - ALSA client library"
	pkg_install() {
		vmove usr/lib/alsa-lib
	}
}

libjack-pipewire_package() {
	depends="libpipewire-${version}_${revision}"
	short_desc+=" - JACK client library"
	pkg_install() {
		vmove usr/lib/pipewire-0.3/jack
		vmove usr/bin/pw-jack
	}
}

pipewire-doc_package() {
	short_desc+=" - documentation"
	pkg_install() {
		vmove usr/share/doc
	}
}

pipewire-pulseaudio-dropin_package() {
	depends="libpulseaudio-pipewire libspa-alsa libspa-audioconvert"
	short_desc+=" - Use pipewire as drop-in replacement for PulseAudio"
	pkg_install() {
		mkdir -p ${PKGDESTDIR}/usr/lib
		for lib in libpulse-mainloop-glib libpulse-simple libpulse; do
			ln -sf pipewire-0.3/pulse/$lib.so.0 ${PKGDESTDIR}/usr/lib/$lib.so.0.999.0
		done
	}
}

pipewire-jack-dropin_package() {
	depends="libjack-pipewire"
	short_desc+=" - Use pipewire as drop-in replacement for JACK"
	pkg_install() {
		mkdir -p ${PKGDESTDIR}/usr/lib
		for lib in libjack libjacknet libjackserver; do
			ln -sf pipewire-0.3/jack/$lib.so.0 ${PKGDESTDIR}/usr/lib/$lib.so.0.999.0
		done
	}
}
